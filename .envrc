# Figure out our current worktree's root dir
export GIT_WT_DIR="$(git rev-parse --show-toplevel 2>/dev/null)"
if [ -n "$GIT_WT_DIR" ]; then
  # If our .git is a directory, then we are in the main worktree
  if [ -d "$GIT_WT_DIR/.git" ]; then
    export GIT_WT_MAIN_DIR="$GIT_WT_DIR"
  else
    # .git is a file, get the path to the common main worktree package
    gitdir_path="$(cat "$GIT_WT_DIR/.git" | sed -n 's|^gitdir: ||p')"
    # Main worktree is always the parent directory of .git
    export GIT_WT_MAIN_DIR="$(dirname "$(dirname "$(dirname "$gitdir_path")")")"
  fi
fi

# Use relevant dev shell if using flakes
branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")
case "${branch}" in
    'main' | 'master')  use flake .#default ;;
    *'feature'*)        use flake .#default ;;
    *)                  use flake ;;
esac

# Make the symlinks if we exist
export GIT_REPO_NAME="$(basename "${GIT_WT_MAIN_DIR}")"
if [ -d "${XDG_PROJECTS_DIR}" ]; then
    conf_dir="${XDG_PROJECTS_DIR}/AI-Dev/${GIT_REPO_NAME}"
    ln -snf "${conf_dir}/claude-conf"       "${GIT_WT_DIR}/.claude"
    ln -snf "${conf_dir}/taskmaster"        "${GIT_WT_DIR}/.taskmaster"
    ln -snf "${conf_dir}/mcp.json"          "${GIT_WT_DIR}/.mcp.json"
    ln -snf "${conf_dir}/amp-config.md"     "${GIT_WT_DIR}/AGENT.md"
    ln -snf "${conf_dir}/claude-config.md"  "${GIT_WT_DIR}/CLAUDE.md"
fi

# Load environment variables
ENV_FILES=(.env .env.development .env.local .env.development.local)
for f in "${ENV_FILES[@]}" ; do
    dotenv_if_exists "$GIT_WT_MAIN_DIR/$f"
done
